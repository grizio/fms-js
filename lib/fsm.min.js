"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var s=e[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,n,s){return n&&t(e.prototype,n),s&&t(e,s),e}}();!function(t){!function(e){function n(t){var e=new i;return t(e),e._build()}var s=function(){function t(e,n,s){_classCallCheck(this,t),this._currentState=e,this._currentData=n,this._onStateChangedListeners=s,this._states=null,this._toExecute=[],this._toExecuteOut=[]}return _createClass(t,[{key:"fire",value:function(){var t=this._currentState,e=this._states[this._currentState].fire(Array.prototype.slice.call(arguments),this._currentData);if(null==e||e.length<2)throw'All event handlers must return the next state and data. Error for event "'+arguments[0]+'" on state "'+t+'"';if(this._currentState=e[0],this._currentData=e[1],t!=this._currentState)for(var n=0,s=this._onStateChangedListeners.length;s>n;n++)this._onStateChangedListeners[n](t,this._currentState);var a=this._toExecute,i=this._toExecuteOut;this._toExecute=[],this._toExecuteOut=[];for(var n=0,s=a.length;s>n;n++)a[n]();for(var n=0,s=i.length;s>n;n++)setTimeout(i[n],0);return this}},{key:"execute",value:function(t){return this._toExecute.push(t),this}},{key:"executeOut",value:function(t){return this._toExecuteOut.push(t),this}},{key:"describe",value:function(t){var e=[];for(var n in this._states)this._states.hasOwnProperty(n)&&e.push(this._states[n].describe());var s={"Current state":{state:this._currentState,data:this._currentData},"onStateChanged listeners":this._onStateChangedListeners.length,states:e};return null==t||t?JSON.stringify(s,null," "):Object.freeze(s)}}]),t}(),a=function(){function t(e,n,s){_classCallCheck(this,t),this._name=e,this._fsm=n,this._handlers=s}return _createClass(t,[{key:"fire",value:function(t,e){if(null==t||t.length<1)throw"The function fire must be called at least with the event name";var n=t[0],s=[e].concat(t.slice(1));if(n in this._handlers)return this._handlers[n].apply(this._fsm,s);throw'The event "'+n+'" does not exist in state "'+this._name+'"'}},{key:"describe",value:function(){var t=[];for(var e in this._handlers)this._handlers.hasOwnProperty(e)&&t.push(e);return{name:this._name,handlers:t}}}]),t}(),i=function(){function t(){_classCallCheck(this,t),this._initialState=null,this._initialData=null,this._states={},this._onStateChangedListeners=[]}return _createClass(t,[{key:"startWith",value:function(t,e){return this._initialState=t,this._initialData=e,this}},{key:"when",value:function(t,e){var n=new r(t,this);return e(n),this._states[t]=n,this}},{key:"onStateChanged",value:function(t){return this._onStateChangedListeners.push(t),this}},{key:"_build",value:function(){var t=new s(this._initialState,this._initialData,this._onStateChangedListeners),e={};for(var n in this._states)this._states.hasOwnProperty(n)&&(e[n]=this._states[n]._build(t));t._states=e;for(var a in this)this.hasOwnProperty(a)&&"_"!=a.charAt(0)&&(t[a]=this[a]);return Object.seal(t)}}]),t}(),r=function(){function t(e){_classCallCheck(this,t),this._name=e,this._handlers={}}return _createClass(t,[{key:"on",value:function(t,e){return this._handlers[t]=e,this}},{key:"_build",value:function(t){return Object.seal(new a(this._name,t,this._handlers))}}]),t}();t.fsm.create=n}(t.fsm||(t.fsm={}))}(window.k||(window.k={}));